name: Test Trait Definitions

on:
  workflow_dispatch:
  workflow_call:

jobs:
  test-traits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v5

      - name: Setup KubeVela Environment
        uses: ./.github/actions/setup-vela-environment

      - name: Run Trait E2E Tests
        run: |
          echo "Running E2E tests for trait definitions..."
          make test-e2e-traits \
            TESTDATA_PATH=${{ github.workspace }}/test/builtin-definition-example

      - name: Summary
        if: always()
        run: |
          echo "## Trait Definition Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **KubeVela Source:** Extracted from go.mod replace directive" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Definitions" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get traitdefinitions -n vela-system --no-headers | wc -l | xargs -I {} echo "Trait Definitions: {}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Applications" >> $GITHUB_STEP_SUMMARY
          echo "Tested applications from \`test/builtin-definition-example/trait/\`:" >> $GITHUB_STEP_SUMMARY
          ls -1 test/builtin-definition-example/trait/*.yaml | xargs -I {} basename {} | while read f; do echo "- $f"; done >> $GITHUB_STEP_SUMMARY

