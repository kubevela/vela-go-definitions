name: Test Component Definitions

on:
  workflow_dispatch:
  push:
    paths:
      - 'go.mod'
      - 'go.sum'
  pull_request:
    paths:
      - 'go.mod'
      - 'go.sum'

jobs:
  test-components:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v5

      - name: Setup KubeVela Environment
        uses: ./.github/actions/setup-vela-environment

      - name: Run Component E2E Tests
        run: |
          echo "Running E2E tests for component definitions..."
          make test-e2e-components \
            TESTDATA_PATH=${{ github.workspace }}/test/builtin-definition-example

      - name: Summary
        if: always()
        run: |
          echo "## Component Definition Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **KubeVela Source:** Extracted from go.mod replace directive" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Definitions" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get componentdefinitions -n vela-system --no-headers | wc -l | xargs -I {} echo "Component Definitions: {}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Applications" >> $GITHUB_STEP_SUMMARY
          echo "Tested applications from \`test/builtin-definition-example/components/\`:" >> $GITHUB_STEP_SUMMARY
          ls -1 test/builtin-definition-example/components/*.yaml | xargs -I {} basename {} | while read f; do echo "- $f"; done >> $GITHUB_STEP_SUMMARY

